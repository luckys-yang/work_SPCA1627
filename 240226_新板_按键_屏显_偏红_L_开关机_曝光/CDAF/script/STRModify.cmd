@echo off 

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: Modify the string in target file
::                                                                                         By Phil
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: Environment configure
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

set "STRING_USAGE=Usage: STRModify ^<filename^> ^<old string^> ^<new string^> [backup]"

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: check input param
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

set FILE_SRC=%1
set STRING_OLD=%2
set STRING_NEW=%3
set FILE_BAKUP=%4

if "%FILE_SRC%" == "" echo %STRING_USAGE% & goto end
if "%STRING_OLD%" == "" echo %STRING_USAGE% & goto end
if "%STRING_NEW%" == "" echo %STRING_USAGE% & goto end
if "%FILE_BAKUP%" == "" set FILE_BAKUP=1

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: old file process
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

copy /y %FILE_SRC% %FILE_SRC%.bak >NUL 2>NUL
del /f /q %FILE_SRC% >NUL 2>NUL

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: Modify the string
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

for /f "delims=" %%a in ('findstr /n .* %FILE_SRC%.bak') do (
	set str=%%a
	setlocal enabledelayedexpansion
	set str=!str:*:=!
	if "!str!" neq "" set str=!str:%STRING_OLD%=%STRING_NEW%!
	echo/!str!>>%FILE_SRC%
	endlocal
)

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: check if delete the backup file
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

if %FILE_BAKUP% equ 0 (
	del /f /q %FILE_SRC%.bak >NUL 2>NUL
)

:end
